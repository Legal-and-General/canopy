#!/usr/bin/env node

const fsExtra = require('fs-extra');
const path = require('path');

// Configuration - now includes both directories
const variablesDir = path.join(__dirname, '../projects/canopy/src/styles/variables');
const tokensDir = path.join(__dirname, '../projects/canopy/src/styles/tokens');
const outputDir = path.join(__dirname, '../projects/canopy/storybook/css-variables');

// Ensure output directory exists
fsExtra.ensureDirSync(outputDir);

// Convert filename to camelCase for variable naming
const toCamelCase = (str) => {
  return str.replace(/[-_]([a-z])/g, (g) => g[1].toUpperCase());
};

// Get all files recursively from a directory
const getFilesRecursively = (dir) => {
  const results = [];

  // Check if directory exists
  if (!fsExtra.existsSync(dir)) {
    return results;
  }

  const files = fsExtra.readdirSync(dir, { withFileTypes: true });

  for (const file of files) {
    const filePath = path.join(dir, file.name);

    if (file.isDirectory()) {
      results.push(...getFilesRecursively(filePath));
    } else if (file.name.endsWith('.scss') || file.name.endsWith('.css')) {
      results.push(filePath);
    }
  }

  return results;
};

// Convert object to string with proper formatting and escape single quotes in values
const objectToString = (obj) => {
  const formattedItems = Object.entries(obj)
    .map(([key, value]) => {
      // Escape single quotes in the value
      const escapedValue = value.replace(/'/g, "\\'");
      return `  '${key}': '${escapedValue}'`;
    })
    .join(',\n');
  return `{\n${formattedItems}\n}`;
};

// Process files from a specific directory
const processFilesFromDirectory = (sourceDir, outputSubDir = '') => {
  // Check if directory exists
  if (!fsExtra.existsSync(sourceDir)) {
    console.log(`Directory does not exist: ${sourceDir}`);
    return;
  }

  console.log(`Processing directory: ${sourceDir}`);

  // Get all scss/css files recursively
  const files = getFilesRecursively(sourceDir);

  console.log(`Found ${files.length} CSS/SCSS files in ${sourceDir}`);

  files.forEach(filePath => {
    const content = fsExtra.readFileSync(filePath, 'utf-8');

    // Extract variable names and values (--variable-name: value format)
    // Using 's' flag to allow matching across newlines
    const variableRegex = /(--[a-zA-Z0-9-]+)\s*:\s*([^;]+);/gs;
    const matches = [...content.matchAll(variableRegex)];

    // Create object with variable name as key and value as value
    const variablesObj = {};
    matches.forEach(match => {
      const name = match[1];
      // Normalize whitespace: replace multiple spaces/newlines with single space, then trim
      const value = match[2].replace(/\s+/g, ' ').trim();
      // If we already have this variable name, don't overwrite it
      if (!variablesObj[name]) {
        variablesObj[name] = value;
      }
    });

    if (Object.keys(variablesObj).length > 0) {
      // Create relative path from sourceDir
      const relativePath = path.relative(sourceDir, filePath);

      // Create output filename - remove underscore and change extension to .ts
      const fileName = path.basename(relativePath).replace(/^_/, '').replace(/\.(scss|css)$/, '.ts');

      // Get base name without extension for the variable name
      const baseFileName = path.basename(relativePath).replace(/^_/, '').replace(/\.(scss|css)$/, '');
      const variableName = toCamelCase(baseFileName) + 'Variables';

      // For nested files, create appropriate directory structure
      const relativeDir = path.dirname(relativePath);
      const outputPath = path.join(outputDir, outputSubDir, relativeDir);

      // Ensure the output directory exists (handles nested directories)
      fsExtra.ensureDirSync(outputPath);

      const outputFilePath = path.join(outputPath, fileName);

      // Generate the TypeScript content with default export for compatibility
      const tsContent = `// AUTO-GENERATED FILE - DO NOT MODIFY
// Generated by generate-css-variables.js from ${path.relative(__dirname, filePath)}

const ${variableName} = ${objectToString(variablesObj)};

export default ${variableName};
`;

      fsExtra.writeFileSync(outputFilePath, tsContent);
      console.log(`Generated ${outputFilePath} with ${Object.keys(variablesObj).length} variables as ${variableName}`);
    } else {
      console.log(`No CSS variables found in ${filePath}`);
    }
  });
};

// Clean up existing output directory
const cleanOutputDir = () => {
  if (fsExtra.existsSync(outputDir)) {
    fsExtra.emptyDirSync(outputDir);
    console.log(`Cleaned output directory: ${outputDir}`);
  }
};

// Main execution
try {
  cleanOutputDir();

  // Process variables directory
  console.log('\n=== Processing variables directory ===');
  processFilesFromDirectory(variablesDir, 'variables');

  // Process entire tokens directory (including all subdirectories)
  console.log('\n=== Processing tokens directory (all subdirectories) ===');
  processFilesFromDirectory(tokensDir, 'tokens');

  console.log('\nCSS variables extraction completed successfully!');
} catch (error) {
  console.error('Error generating CSS variables:', error);
  process.exit(1);
}
