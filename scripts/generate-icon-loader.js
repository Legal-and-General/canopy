#!/usr/bin/env node

/**
 * Generates a static icon loader that uses lazy chunks.
 * This approach works with the new Angular builder by avoiding dynamic import template literals.
 * Instead, it creates a static mapping of icon names to lazy import functions.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function generateIconLoader(config) {
  const { sourceDir, outputFile, prefix, interfaceName } = config;

  // Read all icon files
  const iconsDir = path.join(sourceDir, 'set');
  const files = fs.readdirSync(iconsDir)
    .filter(file => file.endsWith('.icon.ts') && !file.includes('Array'));

  // Determine the interface file name
  const interfaceFile = prefix === 'lgIcon' ? 'ui-icons-files' : 'brand-icons-files';

  // Generate the lazy loader entries
  const loaderEntries = files
    .map(file => {
      const iconFileName = file.replace('.icon.ts', '');
      const iconKey = iconFileName.replace(`${prefix}-`, '');
      const exportName = iconFileName.split('-')
        .map((part, i) => i === 0 ? part : part.charAt(0).toUpperCase() + part.slice(1))
        .join('');

      return `  '${iconKey}': () => import('../${path.basename(sourceDir)}/set/${iconFileName}.icon').then(m => m.${exportName}),`;
    })
    .join('\n');

  // Generate the file content
  const content = `/* ðŸ¤– This file is auto-generated by scripts/generate-icon-loader.js */
import type { ${interfaceName} } from '../${path.basename(sourceDir)}/set/${interfaceFile}.interface';

/**
 * Lazy icon loader using static imports.
 * Each icon is loaded on-demand using dynamic import(), but the imports are statically defined
 * so they work with the new Angular builder (esbuild).
 *
 * This creates separate lazy chunks for each icon, keeping the initial bundle small.
 */
export const ICON_LOADER: Record<string, () => Promise<${interfaceName}>> = {
${loaderEntries}
};
`;

  // Write the file
  const outputPath = path.join(__dirname, '..', outputFile);
  fs.writeFileSync(outputPath, content, 'utf-8');
  console.log(`âœ… Generated ${outputFile} with ${files.length} lazy icon loaders`);
}

// Generate for both icon sets
generateIconLoader({
  sourceDir: 'projects/canopy/src/lib/ui-icons-files',
  outputFile: 'projects/canopy/src/lib/icon/icon-loader.ts',
  prefix: 'lgIcon',
  interfaceName: 'Icon',
});

generateIconLoader({
  sourceDir: 'projects/canopy/src/lib/brand-icons-files',
  outputFile: 'projects/canopy/src/lib/brand-icon/brand-icon-loader.ts',
  prefix: 'lgBrandIcon',
  interfaceName: 'BrandIcon',
});

console.log('\nðŸŽ¯ Icon loader files generated successfully!');
console.log('   Each icon will be loaded as a separate lazy chunk on-demand.\n');

